---
// 直接硬编码 Giscus 配置
const GISCUS_CONFIG = {
	REPO: "RichardQt/Astro-blog-Cactus",
	REPO_ID: "R_kgDONoGd2A",
	CATEGORY_ID: "DIC_kwDONoGd2M4Cl7rH",
	LANG: "zh-CN"
};
---

<div id="comments" class="mt-8">
	<div class="giscus"></div>
</div>

<script define:vars={{ config: GISCUS_CONFIG }}>
	function getCurrentTheme() {
		return document.documentElement.classList.contains("dark") ? "dark_dimmed" : "light";
	}

	function createGiscusScript() {
		const container = document.querySelector(".giscus");
		const theme = getCurrentTheme();
		console.log("Current theme:", theme);
		let script = document.createElement("script");
		script.src = "https://giscus.app/client.js";
		script.setAttribute("data-repo", config.REPO);
		script.setAttribute("data-repo-id", config.REPO_ID);
		script.setAttribute("data-category", "Announcements");
		script.setAttribute("data-category-id", config.CATEGORY_ID);
		script.setAttribute("data-mapping", "url");
		script.setAttribute("data-strict", "0");
		script.setAttribute("data-reactions-enabled", "1");
		script.setAttribute("data-emit-metadata", "0");
		script.setAttribute("data-input-position", "top");
		script.setAttribute("data-theme", theme);
		script.setAttribute("data-lang", config.LANG);
		script.setAttribute("data-loading", "lazy");
		script.setAttribute("crossorigin", "anonymous");
		
		script.setAttribute("data-host", "https://giscus.app");
		script.setAttribute("data-origins", window.location.origin);
		script.async = true;
		container && container.appendChild(script);
	}

	// 等待 DOM 完全加载
	if (document.readyState === "loading") {
		document.addEventListener("DOMContentLoaded", createGiscusScript);
	} else {
		createGiscusScript();
	}

	// 主题切换
	document.querySelector("#theme-btn")?.addEventListener("click", () => {
		setTimeout(() => {
			const theme = getCurrentTheme();
			console.log("Theme changed to:", theme);
			const iframe = document.querySelector("iframe.giscus-frame");
			if (iframe && iframe.contentWindow) {
				iframe.contentWindow.postMessage(
					{ giscus: { setConfig: { theme } } },
					"https://giscus.app"
				);
			}
		}, 300);
	});
</script>
